function isEmpty(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}function remove(a,b){for(var c=a.indexOf(b);c!==-1;)a.splice(c,1),c=a.indexOf(b)}function getVideoId(a){var b=/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/,c=a.match(b);return!(!c||11!=c[7].length)&&c[7]}function getRandomArrayVals(a,b){for(var c=a.slice(a),d=[],e=0;e<b;e++){var f=Math.floor(Math.random()*c.length),g=c.splice(f,1);d.push(g[0])}return d}function clearMainSearch(a){$("#search_bar").val(""),a(function(){$("[search-bar]").typeahead("val","")},0)}var youtube=new Bloodhound({remote:{url:"/api/youtube/search/%QUERY%",wildcard:"%QUERY%"},datumTokenizer:Bloodhound.tokenizers.whitespace("q"),queryTokenizer:Bloodhound.tokenizers.whitespace}),soundcloud=new Bloodhound({remote:{url:"/api/soundcloud/search/%QUERY%",wildcard:"%QUERY%"},datumTokenizer:Bloodhound.tokenizers.whitespace("q"),queryTokenizer:Bloodhound.tokenizers.whitespace}),app=angular.module("app",["ui.router","ngFileUpload","ngAnimate","infinite-scroll"]);angular.module("infinite-scroll").value("THROTTLE_MILLISECONDS",250),app.run(function(){$.notify.addStyle("below-nav",{html:"<div><span data-notify-text/></div>",classes:{base:{"background-color":"#B80A5F",color:"white",padding:"10px"}}})}),app.config(["$stateProvider","$urlRouterProvider","$locationProvider","$logProvider",function(a,b,c,d){c.html5Mode({enabled:!0,requireBase:!1}),d.debugEnabled(!0),a.state("home",{url:"/",templateUrl:"/templates/home.html",controller:"HomeCtrl"}).state("all_playlists",{url:"/playlists",templateUrl:"/templates/all_playlists.html",controller:"AllPlaylistsCtrl"}).state("profile",{url:"/profile/:username",templateUrl:"/templates/user_profile.html",controller:"ProfileCtrl"}).state("user_playlist",{url:"/:username/:playlistSlug",templateUrl:"/templates/user_playlist.html",controller:"PlaylistCtrl"}).state("all_profiles",{url:"/profiles",templateUrl:"/templates/all_profiles.html",controller:"AllProfilesCtrl"}),b.otherwise("/")}]),app.controller("AllProfilesCtrl",["$scope","UserPagination",function(a,b){a.pagination=new b}]),app.controller("AuthCtrl",["$scope","AuthService","$rootScope",function(a,b,c){a.user={},a.register=function(){$("#submit-register").prop("disabled",!0),b.register(a.user).error(function(b){a.registerError=b}).success(function(){$("#register-modal").modal("hide"),a.user={}}).finally(function(){$("#submit-register").prop("disabled",!1)})},a.logIn=function(){$("#submit-login").prop("disabled",!0),b.logIn(a.user).error(function(b){a.loginError=b}).success(function(){c.$emit("auth:logged-in",a.user.username),a.user={}}).finally(function(){$("#submit-login").prop("disabled",!1)})}}]),app.factory("AuthService",["$http","$window",function(a,b){var c={};return c.saveToken=function(a){b.localStorage["musicality-token"]=a},c.getToken=function(){return b.localStorage["musicality-token"]},c.isLoggedIn=function(){var a=c.getToken();if(a){var d=JSON.parse(b.atob(a.split(".")[1]));return d.exp>Date.now()/1e3}return!1},c.currentUser=function(){if(c.isLoggedIn()){var a=c.getToken(),d=JSON.parse(b.atob(a.split(".")[1]));return d.username}return""},c.register=function(b){return a.post("/api/register",b).success(function(a){c.saveToken(a.token)})},c.logIn=function(b){return a.post("/api/login",b).success(function(a){c.saveToken(a.token)})},c.end=function(){b.localStorage.removeItem("musicality-token")},c}]),app.controller("ProfileCtrl",["$state","PlaylistsService","UserService","$scope","$stateParams","AuthService","$rootScope","$timeout",function(a,b,c,d,e,f,g,h){d.isLoggedIn=f.isLoggedIn,d.createNewAndRedirect=b.createNewAndRedirect,c.getUserDetails(e.username).success(function(a){d.exists=!0,d.user=a,d.refreshAuthor(),d.changeableAttributes={},d.changeableAttributes.profileImg=d.user.img}).error(function(){d.exists=!1}),d.refreshAuthor=function(){if(d.exists){if(!d.isLoggedIn())return void(d.isAuthor=!1);d.isAuthor=e.username===f.currentUser()}},d.uploadProfileImg=function(a){var b=new window.FileReader;try{b.readAsDataURL(a)}catch(a){}b.onloadend=function(){a&&c.uploadProfileImg(f.currentUser(),a).success(function(a){d.changeableAttributes.profileImgNew=b.result,d.changeableAttributes.profileImg=a.user.img,$.notify("You have successfully changed your profile image.",{style:"below-nav"})})}},g.$on("auth:logged-in",function(){h(function(){d.refreshAuthor()},0)}),g.$on("auth:logged-out",function(){h(function(){d.refreshAuthor()},0)})}]),app.factory("UserService",["$http","AuthService",function(a,b){var c={};return c.getAllUsers=function(){return a.get("/api/users")},c.getUserDetails=function(b){return a.get("/api/users/"+b)},c.uploadProfileImg=function(c,d){var e=new FormData;return e.append("image",d),a.post("/api/users/"+c+"/image",e,{transformRequest:angular.identity,headers:{"Content-Type":void 0,Authorization:"Bearer "+b.getToken()}})},c.updateUserProfile=function(c,d){var e={method:"PUT",url:"/api/users/"+c,headers:{Authorization:"Bearer "+b.getToken()},data:d};return a(e)},c}]),app.factory("UserPagination",["$http",function(a){var b=function(){this.items=[],this.busy=!1,this.page=1,this.done=!1};return b.prototype.nextPage=function(){if(!this.done){if(this.busy)return;this.busy=!0;var b="/api/users/page/"+this.page;a.get(b).success(function(a){if(_.isEmpty(a))return void(this.done=!0);for(var b=0;b<a.length;b++)this.items.push(a[b]);this.page+=1,this.busy=!1}.bind(this))}},b}]),app.directive("profileImageEditor",function(){return{templateUrl:"/templates/partials/user_profile/user_img.html"}}),app.directive("userDetails",function(){return{templateUrl:"/templates/partials/user_profile/user_details.html"}}),app.factory("FlashService",function(){var a={};return a.fieldsChangeMessage="",a}),app.controller("HomeCtrl",["$scope","PlaylistsService","NowPlayingService","$timeout",function(a,b,c,d){a.playTrack=c.playTrack,a.clear=function(){clearMainSearch(d)},b.getRecentPlaylists().success(function(b){a.recentPlaylists=b,a.recentPlaylists.forEach(function(a){a.featuredTracks=getRandomArrayVals(a.tracks,3)})})}]),app.directive("searchBar",["$compile",function(a){return{restrict:"A",link:function(b,c){$(c).focus(function(){$("#hide-for-search").fadeOut("fast",function(){$("#search_results").fadeIn("fast")})}).blur(function(){$("#search_results").fadeOut("fast",function(){$("#hide-for-search").fadeIn("fast")})}),$(c).typeahead({hint:!0,highlight:!0,minLength:1,menu:$("#main-search-results"),classNames:{dataset:"col-md-6"}},{source:youtube.ttAdapter(),name:"youtubeSearch",display:"title",templates:{header:"<h2 class='center'>YouTube</h2>",suggestion:function(c){return a("<a tsource='"+c.source+"' title='"+c.title+"' playback-url='"+c.playbackURL+"' add-to-playlist class='list-group-item'>"+c.title+"</a>")(b)}}},{source:soundcloud.ttAdapter(),name:"soundcloudSearch",display:"title",templates:{header:"<h2 class='center'>SoundCloud</h2>",suggestion:function(c){return a("<a tsource='"+c.source+"' title='"+c.title+"' playback-url='"+c.playbackURL+"' add-to-playlist class='list-group-item'>"+c.title+"</a>")(b)}}})}}}]),app.controller("NavCtrl",["$window","$scope","$rootScope","$http","AuthService","PlaylistsService","$state","NowPlayingService",function(a,b,c,d,e,f,g,h){b.isLoggedIn=e.isLoggedIn,b.currentUser=e.currentUser,b.endNowPlaying=h.endNowPlaying,b.reloadCurrentPlaylist=h.reloadCurrentPlaylist,b.getSCState=h.getSCState,b.setSCState=h.setSCState,b.playTrack=h.playTrack,b.getNowPlaying=h.getNowPlaying,b.toggleTrackState=h.toggleTrackState,b.getPlayerState=h.getPlayerState,b.playNextTrack=h.playNextTrack,b.hasNextTrack=h.hasNextTrack,b.playPreviousTrack=h.playPreviousTrack,b.hasPreviousTrack=h.hasPreviousTrack,b.volumeUp=h.volumeUp,b.volumeDown=h.volumeDown,b.volumeMute=h.volumeMute,b.getYTPlayer=h.getYTPlayer,b.getSCPlayer=h.getSCPlayer,b.logOut=function(){c.$emit("auth:logged-out",""),e.end()},b.createNewBlankPlaylist=f.createNewAndRedirect,c.$on("yt-state-change",function(a,c){c===YT.PlayerState.ENDED&&b.hasNextTrack()&&b.playNextTrack(),b.$apply()}),c.$on("sc-state-change",function(a,c){b.scState=c,setTimeout(function(){b.$apply()},100)}),c.$on("volume-change",function(a,c){setTimeout(function(){b.volume=c,b.$apply()},100)}),c.$on("yt-ready",function(a,c){c.target.setVolume(100),b.volume=100,b.$apply()}),b.playPauseCondition=function(){try{return 3===b.getYTPlayer().getPlayerState()}catch(a){}},b.playCondition=function(){try{if(b.getNowPlaying()){if("YouTube"===b.getNowPlaying().track.source)return 2===b.getYTPlayer().getPlayerState()||3===b.getYTPlayer().getPlayerState()||0===b.getYTPlayer().getPlayerState();if("SoundCloud"===b.getNowPlaying().track.source)return 2===b.getSCState()||0===b.getSCState()}}catch(a){}return!b.getNowPlaying()},b.pauseCondition=function(){try{if(b.getNowPlaying()){if("YouTube"===b.getNowPlaying().track.source)return 1===b.getYTPlayer().getPlayerState();if("SoundCloud"===b.getNowPlaying().track.source)return 1===b.getSCState()}}catch(a){}return!b.getNowPlaying()}}]),app.factory("TagService",["$http",function(a){var b={};return b.getAllTags=function(){return a.get("/api/tags")},b}]),app.factory("NowPlayingService",["$window","$rootScope","PlaylistsService",function(a,b,c){var d={};return d.nowPlaying=null,d.ytPlayer=null,d.scPlayer=null,d.scState=null,d.getNowPlaying=function(){return d.nowPlaying},d.getYTPlayer=function(){return d.ytPlayer},d.setYTPlayer=function(a){d.ytPlayer=a},d.getSCPlayer=function(){return d.scPlayer},d.setSCPlayer=function(a){d.scPlayer=a},d.getSCState=function(){return d.scState},d.setSCState=function(a){d.scState=a},d.playTrack=function(a,b){d.disposeOf(),"YouTube"===a.source?(d.nowPlaying={track:a,fromPlaylist:b},d.playYTTrack(a)):"SoundCloud"===a.source&&(d.nowPlaying={track:a,fromPlaylist:b},d.playSCTrack(a));var c=$(".now-playing-sidebar");c.hasClass("sidebar-open")||c.addClass("sidebar-open"),document.title="Currently playing: "+a.title},d.toggleTrackState=function(){"YouTube"===d.getNowPlaying().track.source?d.getYTPlayer().getPlayerState()===YT.PlayerState.PLAYING?d.getYTPlayer().pauseVideo():d.getYTPlayer().getPlayerState()!==YT.PlayerState.PAUSED&&d.getYTPlayer().getPlayerState()!==YT.PlayerState.ENDED||d.getYTPlayer().playVideo():"SoundCloud"===d.getNowPlaying().track.source&&(1===d.scState?d.getSCPlayer().pause():2===d.scState?d.getSCPlayer().play():0===d.scState&&d.getSCPlayer().play())},d.disposeOf=function(){try{d.getYTPlayer().stopVideo()}catch(a){}try{d.getSCPlayer().pause(),$("[sc-player]").css("visibility","hidden")}catch(a){}d.nowPlaying=null,document.title="Musicality"},d.playYTTrack=function(a){d.getYTPlayer().loadVideoById(getVideoId(a.playbackURL))},d.playSCTrack=function(a){var c=$("[sc-player]");if(d.getSCPlayer())d.getSCPlayer().load(a.playbackURL,{show_artwork:!1,liking:!1,sharing:!1,auto_play:!0,buying:!1,show_comments:!1,show_playcount:!1,download:!1});else{c.attr("src","https://w.soundcloud.com/player/?url="+a.playbackURL+"&show_artwork=false&liking=false&sharing=false&auto_play=true&buying=false&show_comments=false&show_playcount=false&download=false");var e=SC.Widget(c[0]);e.setVolume(1),b.$emit("volume-change",1),e.bind(SC.Widget.Events.PLAY,function(){d.setSCState(1),b.$emit("sc-state-change",1)}),e.bind(SC.Widget.Events.PAUSE,function(){d.setSCState(2),b.$emit("sc-state-change",2)}),e.bind(SC.Widget.Events.FINISH,function(){d.setSCState(0),d.hasNextTrack()&&d.playNextTrack(),b.$emit("sc-state-change",0)}),e.bind(SC.Widget.Events.PLAY_PROGRESS,function(){e.getDuration(function(a){e.getPosition(function(c){b.$emit("sc-playing",{duration:a,position:c})})})}),d.setSCPlayer(e)}c.css("visibility","visible")},d.endNowPlaying=function(){var a=$(".now-playing-sidebar");a.hasClass("sidebar-open")&&a.removeClass("sidebar-open"),d.disposeOf()},d.reloadCurrentPlaylist=function(){try{c.getAllPlaylists({_id:d.nowPlaying.fromPlaylist._id}).success(function(a){a&&(d.nowPlaying.fromPlaylist=a[0])})}catch(a){}},d.findIndex=function(a){var b=_.findIndex(d.getNowPlaying().fromPlaylist.tracks,function(a){return a.playbackURL==d.getNowPlaying().track.playbackURL});return b+a},d.hasNextTrack=function(){return!!d.getNowPlaying().fromPlaylist.tracks[d.findIndex(1)]},d.playNextTrack=function(){d.playTrack(d.getNowPlaying().fromPlaylist.tracks[d.findIndex(1)],d.getNowPlaying().fromPlaylist)},d.hasPreviousTrack=function(){return!!d.getNowPlaying().fromPlaylist.tracks[d.findIndex(-1)]},d.playPreviousTrack=function(){d.playTrack(d.getNowPlaying().fromPlaylist.tracks[d.findIndex(-1)],d.getNowPlaying().fromPlaylist)},d.volumeUp=function(){d.setVolume(100,1)},d.volumeDown=function(){d.setVolume(50,.5)},d.volumeMute=function(){d.setVolume(0,0)},d.setVolume=function(a,c){"YouTube"===d.getNowPlaying().track.source?(d.getYTPlayer().setVolume(a),b.$emit("volume-change",a)):"SoundCloud"===d.getNowPlaying().track.source&&(d.getSCPlayer().setVolume(c),b.$emit("volume-change",c))},d.playPlaylist=function(a){a.tracks[0]&&d.playTrack(a.tracks[0],a)},d}]),app.directive("ytPlayerInit",["$window","$rootScope","NowPlayingService",function(a,b,c){return{restrict:"A",link:function(){var d=document.createElement("script");d.src="/compiled/iframe_api.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(d,e),a.onYouTubeIframeAPIReady=function(){c.setYTPlayer(new YT.Player("yt-player",{height:"390",width:"640",playerVars:{html5:1,autoplay:1,showinfo:0,controls:0,rel:0,iv_load_policy:3,disablekb:1},events:{onReady:function(a){b.$emit("yt-ready",a)},onStateChange:function(a){b.$emit("yt-state-change",a.data)}}}))}}}}]);var posTimer,scListener,runScListener=!0;app.directive("playerSlider",["$rootScope","NowPlayingService",function(a,b){return{restrict:"A",link:function(c,d){function e(a,c,d){if(b.getNowPlaying())if("YouTube"===b.getNowPlaying().track.source){var e=b.getYTPlayer().getDuration();if(0!==e){var f=a.value*e/100;b.getYTPlayer().seekTo(f,c)}}else"SoundCloud"===b.getNowPlaying().track.source&&(d||(b.getSCPlayer().getDuration(function(c){0!==c&&b.getSCPlayer().seekTo(a.value*c/100)}),runScListener=!0))}function f(){"YouTube"===b.getNowPlaying().track.source?posTimer=setInterval(function(){if("function"==typeof b.getYTPlayer().getCurrentTime){var a=b.getYTPlayer().getCurrentTime(),c=b.getYTPlayer().getDuration(),e=a/c*100;$(d).slider("setValue",e)}},1e3):"SoundCloud"===b.getNowPlaying().track.source&&(scListener=a.$on("sc-playing",function(a,b){if(runScListener){var c=b.duration,e=b.position,f=c/1e3,g=e/1e3,h=g/f*100;$(d).slider("setValue",h)}}))}function g(){clearInterval(posTimer),runScListener=!1}$(d).slider({id:"playback-slider",min:0,max:100,step:1,orientation:"horizontal",value:0,enabled:!1,handle:"round",tooltip:"hide"}),angular.forEach(["yt-state-change","sc-state-change"],function(c){a.$on(c,function(a,c){1===c?($(d).slider("enable"),runScListener=!0,f()):0!==c&&c!==-1&&b.getNowPlaying()?g():(g(),$(d).slider("disable"))})}),$(d).slider().on("slideStart",function(a){g()}),$(d).slider().on("slide",function(a){e(a,!1,!0)}),$(d).slider().on("slideStop",function(a){e(a,!0,!1)}),$(d).slider().on("change",function(a){e(a,!0,!0)})}}}]),app.controller("AllPlaylistsCtrl",["$scope","PlaylistsService","PlaylistPagination","NowPlayingService",function(a,b,c,d){a.pagination=new c,a.playTrack=d.playTrack}]),app.controller("PlaylistCtrl",["$scope","$stateParams","AuthService","PlaylistsService","NowPlayingService","$rootScope","$timeout","FlashService","UserService",function(a,b,c,d,e,f,g,h,i){a.currentUser=c.currentUser,a.isLoggedIn=c.isLoggedIn,a.getUserDetails=i.getUserDetails,a.playTrack=function(b){e.playTrack(b,a.playlist)},a.playPlaylist=function(){e.playPlaylist(a.playlist)},d.getAllPlaylists({createdBy:b.username}).success(function(c){a.playlist=_.findWhere(c,{slug:b.playlistSlug}),a.playlist?(a.exists=!0,a.refreshLiked(),a.refreshAuthor(),""!==h.fieldsChangeMessage&&(a.fieldsChangeMessage=h.fieldsChangeMessage,e.reloadCurrentPlaylist(),h.fieldsChangeMessage=""),a.tracksToBeAdded=[],a.changeableAttributes={},a.changeableAttributes.name=a.playlist.name,a.changeableAttributes.description=a.playlist.description,a.changeableAttributes.playlistArt=a.playlist.art,a.changeableAttributes.comment="",a.tags=a.playlist.tags,a.comments=a.playlist.comments,a.comments.forEach(function(b){a.getProfileImgFromObj(b).success(function(a){b.img=a.img})}),a.likes=a.playlist.likes,a.likes.forEach(function(b){a.getProfileImgFromObj(b).success(function(a){b.img=a.img})}),a.tracks=a.playlist.tracks,a.allAuthorPlaylists=_.filter(c,function(b){return b.name!==a.playlist.name}),a.above3AuthorPlaylists=_.reject(a.allAuthorPlaylists,function(a){return a.tracks.length<3}),d.addView(a.playlist)):a.exists=!1}),a.addTag=function(){var b=a.tags.newTag;b&&(a.tags.indexOf(b)>-1?(a.error="Your playlist already contains that tag.",a.tags.newTag=""):(a.playlist.tags.push(b),a.error="",a.tags.newTag="",$("#tags-search").typeahead("val",""),d.addTagToPlaylist(a.playlist,b)))},a.deleteTag=function(b,c){d.deleteTagFromPlaylist(a.playlist,c),remove(a.tags,c),a.error=""},a.addTrackToBeAdded=function(b){var c=_.findWhere(a.tracksToBeAdded,{playbackURL:b.playbackURL});c?a.message="That track is already in the to-be-added queue!":(a.message="",a.tracksToBeAdded.push(b),a.tracksToBeAdded.newTrack="",$("#quick-add-search").typeahead("val",""))},a.addTracksInQueueToPlaylist=function(){if(!_.isEmpty(a.tracksToBeAdded)){var b=!1;a.tracksToBeAdded.forEach(function(c){var d=_.findWhere(a.tracks,{playbackURL:c.playbackURL});d?b=!0:a.addTrackToPlaylist(c)}),a.tracksToBeAdded=[],b?a.message="Duplicates were found so some tracks may not have been added.":a.message="Tracks successfully added. Perhaps you'd want to add a few more?"}},a.removeTrackFromAddQueue=function(b,c){a.tracksToBeAdded.forEach(function(d){d.title===b&&d.playbackURL===c&&remove(a.tracksToBeAdded,d)})},a.addTrackToPlaylist=function(b){d.addTrackToPlaylist(a.playlist,b).success(function(){a.tracks.push(b),e.reloadCurrentPlaylist()})},a.deleteTrackFromPlaylist=function(b){for(var c=0;c<a.tracks.length;c++){var e=a.tracks[c];if(e.playbackURL===b){a.tracks.splice(c,1);break}}d.deleteTrackFromPlaylist(a.playlist,b)},a.deleteAllTracks=function(){d.deleteAllPlaylistTracks(a.playlist).success(function(){$.notify("Finished deleting all tracks from the playlist.",{style:"below-nav"}),a.tracks=[],a.hideDeleteModal()})},a.hideDeleteModal=function(){$("#tracks-delete-modal").modal("hide")},a.uploadArt=function(b){var c=new window.FileReader;c.readAsDataURL(b),c.onloadend=function(){b&&d.uploadPlaylistArt(a.playlist,b).success(function(b){a.changeableAttributes.playlistArtNew=c.result,a.changeableAttributes.playlistArt=b.playlist.art,$.notify("Playlist art changed successfully.",{style:"below-nav"})})}},a.refreshAuthor=function(){if(a.exists){if(!a.isLoggedIn())return void(a.isAuthor=!1);a.isAuthor=a.playlist.createdBy===c.currentUser()}},a.addComment=function(){a.commentActionMsg="";var b=a.changeableAttributes.comment;b&&d.addPlaylistComment(a.playlist,a.changeableAttributes.comment).success(function(b){a.commentActionMsg=b.message,a.getProfileImgFromObj(b.addedComment).success(function(c){b.addedComment.img=c.img,a.comments.push(b.addedComment)})}).error(function(b){a.commentActionMsg=b.message,a.changeableAttributes.comment=""})},a.deleteComment=function(b,c){a.commentActionMsg="",d.deletePlaylistComment(a.playlist,b,c).success(function(b){a.commentActionMsg=b.message,a.comments=_.reject(a.comments,function(a){return a.username===b.delComment.username&&a.created===b.delComment.created&&a.comment===b.delComment.comment})}).error(function(b){a.commentActionMsg=b.message})},a.clearComments=function(){a.changeableAttributes.comment=""},a.like=function(){d.likePlaylist(a.playlist).success(function(b){a.getProfileImgFromObj(b.addedLike).success(function(c){b.addedLike.img=c.img,a.playlist.likes.push(b.addedLike),a.refreshLiked()})})},a.refreshLiked=function(){if(a.exists&&a.isLoggedIn()){var b=_.findWhere(a.playlist.likes,{username:a.currentUser()});return void(a.liked=!!b)}a.liked=!0},a.unlike=function(){d.unlikePlaylist(a.playlist).success(function(b){a.playlist.likes.splice(a.playlist.likes.indexOf(b.delLike),1),a.refreshLiked()})},a.getProfileImgFromObj=function(b){return a.getUserDetails(b.username)},f.$on("auth:logged-in",function(){g(function(){a.refreshAuthor()},0)}),f.$on("auth:logged-out",function(){g(function(){a.refreshAuthor()},0)})}]),app.factory("PlaylistsService",["$state","$http","AuthService",function(a,b,c){var d={};return d.getAllPlaylists=function(a){return b({method:"GET",url:"/api/playlists",params:a})},d.getRecentPlaylists=function(a){return b({method:"GET",url:"/api/playlists/recent",params:a})},d.createNewBlankPlaylist=function(){var a={method:"POST",url:"/api/playlists/blank",headers:{Authorization:"Bearer "+c.getToken()}};return b(a)},d.createNewAndRedirect=function(){d.createNewBlankPlaylist().success(function(b){a.go("user_playlist",{username:b.createdBy,playlistSlug:b.slug})})},d.addView=function(a){return b({method:"PUT",url:"/api/playlists/"+a._id+"/views"})},d.updateName=function(a,d){var e={method:"PUT",url:"/api/playlists/"+a._id+"/name",headers:{Authorization:"Bearer "+c.getToken()},data:{name:d}};return b(e)},d.updatePlaylistFields=function(a,d){var e={method:"PUT",url:"/api/playlists/"+a._id,headers:{Authorization:"Bearer "+c.getToken()},data:d};return b(e)},d.addTagToPlaylist=function(a,d){var e={method:"PUT",url:"/api/playlists/"+a._id+"/tags",headers:{Authorization:"Bearer "+c.getToken()},data:{tag:d}};return b(e)},d.deleteTagFromPlaylist=function(a,d){var e={method:"DELETE",url:"/api/playlists/"+a._id+"/tags",headers:{Authorization:"Bearer "+c.getToken(),"Content-Type":"application/json"},data:{tag:d}};return b(e)},d.addPlaylistComment=function(a,d){var e={method:"PUT",url:"/api/playlists/"+a._id+"/comments",headers:{Authorization:"Bearer "+c.getToken()},data:{comment:d,created:Date.now()}};return b(e)},d.deletePlaylistComment=function(a,d,e){var f={method:"DELETE",url:"/api/playlists/"+a._id+"/comments",headers:{Authorization:"Bearer "+c.getToken(),"Content-Type":"application/json"},data:{username:d,comment:e}};return b(f)},d.likePlaylist=function(a){var d={method:"PUT",url:"/api/playlists/"+a._id+"/likes",headers:{Authorization:"Bearer "+c.getToken()}};return b(d)},d.unlikePlaylist=function(a){var d={method:"DELETE",url:"/api/playlists/"+a._id+"/likes",headers:{Authorization:"Bearer "+c.getToken(),"Content-Type":"application/json"}};return b(d)},d.addTrackToPlaylist=function(a,d){var e={method:"PUT",url:"/api/playlists/"+a._id+"/tracks",headers:{Authorization:"Bearer "+c.getToken()},data:d};return b(e)},d.deleteTrackFromPlaylist=function(a,d){var e={method:"DELETE",url:"/api/playlists/"+a._id+"/tracks",headers:{Authorization:"Bearer "+c.getToken(),"Content-Type":"application/json"},data:{playbackURL:d}};return b(e)},d.deleteAllPlaylistTracks=function(a){var d={method:"DELETE",url:"/api/playlists/"+a._id+"/tracks/all",headers:{Authorization:"Bearer "+c.getToken(),"Content-Type":"application/json"}};return b(d)},d.uploadPlaylistArt=function(a,d){var e=new FormData;return e.append("image",d),b.post("/api/playlists/"+a._id+"/image",e,{transformRequest:angular.identity,headers:{"Content-Type":void 0,Authorization:"Bearer "+c.getToken()}})},d}]),app.factory("PlaylistPagination",["$http",function(a){var b=function(){this.items=[],this.busy=!1,this.page=1,this.done=!1};return b.prototype.nextPage=function(){if(!this.done){if(this.busy)return;this.busy=!0;var b="/api/playlists/page/"+this.page;a.get(b).success(function(a){if(_.isEmpty(a))return void(this.done=!0);for(var b=0;b<a.length;b++)a[b].featuredTracks=getRandomArrayVals(a[b].tracks,3),this.items.push(a[b]);this.page+=1,this.busy=!1}.bind(this))}},b}]),app.directive("playlistArt",function(){return{templateUrl:"/templates/partials/user_playlist/playlist_art.html"}}),app.directive("playlistDetails",function(){return{templateUrl:"/templates/partials/user_playlist/playlist_details.html"}}),app.directive("playlistSummary",function(){return{templateUrl:"/templates/partials/user_playlist/playlist_summary.html"}}),app.directive("playlistToolbar",function(){return{templateUrl:"/templates/partials/user_playlist/playlist_toolbar.html"}}),app.directive("tracks",function(){return{templateUrl:"/templates/partials/user_playlist/tracks.html"}}),app.directive("tracksEdit",function(){return{templateUrl:"/templates/partials/user_playlist/tracks_edit.html"}}),app.directive("comments",function(){return{templateUrl:"/templates/partials/user_playlist/comments.html"}}),app.directive("tagsEdit",function(){return{templateUrl:"/templates/partials/user_playlist/tags.html"}}),app.directive("authorPlaylists",function(){return{templateUrl:"/templates/partials/user_playlist/author_playlists.html"}}),app.directive("likes",function(){return{templateUrl:"/templates/partials/user_playlist/likes.html"}}),app.directive("contenteditable",["PlaylistsService","$state","FlashService",function(a,b,c){return{require:"ngModel",link:function(d,e,f,g){function h(){g.$setViewValue(e.text())}g.$render=function(){e.text(g.$viewValue||"")},e.bind("blur keyup change",function(){d.fieldsChangeMessage="",d.$apply(h)}),e.bind("keydown",function(a){d.fieldsChangeMessage="",13===a.which&&($(e).blur(),window.getSelection().removeAllRanges())}),e.bind("blur",function(){$(e).hasClass("playlist-edit-name")?a.updateName(d.playlist,d.changeableAttributes.name).then(function(a){"You already have a playlist with that name."===a.data.message&&d.playlist.name===d.changeableAttributes.name?d.changeableAttributes.name=d.playlist.name:a.data.redirectUrl&&(c.fieldsChangeMessage=a.data.message,b.go("user_playlist",{username:d.playlist.createdBy,playlistSlug:a.data.redirectUrl}))}):d.changeableAttributes.description!==d.playlist.description&&a.updatePlaylistFields(d.playlist,{description:d.changeableAttributes.description}).success(function(){d.fieldsChangeMessage="The description was successfully updated."})})}}}]),app.run(["$rootScope","$timeout",function(a,b){a.$on("auth:logged-in",function(){$.contextMenu("destroy"),clearMainSearch(b)}),a.$on("auth:logged-out",function(){$.contextMenu("destroy"),clearMainSearch(b)})}]),app.directive("playlistArtMenu",["PlaylistsService",function(a){return{link:function(b,c){b.$watch("isAuthor",function(d){if(void 0!==d){var e={};d===!0&&(e.changeArt={name:"Change playlist art",callback:function(){$(c).trigger("click")}},e.deleteArt={name:"Remove playlist art",callback:function(){a.updatePlaylistFields(b.playlist,{art:"generated"}).success(function(){b.changeableAttributes.playlistArt="generated"})}}),"generated"!==b.changeableAttributes.playlistArt&&(e.getDirectLink={name:"Get direct link to art",callback:function(){window.location.href=b.changeableAttributes.playlistArt}}),_.isEmpty(e)||$.contextMenu({selector:".playlist-art-menu",items:e,trigger:"hover",autoHide:!0})}})}}}]),app.directive("profileImage",["UserService","AuthService",function(a,b){return{link:function(c,d){c.$watch("isAuthor",function(e){if(void 0!==e){$.contextMenu("destroy",".profile-img-menu");var f={};e===!0&&(f.changeArt={name:"Change profile art",callback:function(){$(d).trigger("click")}},f.deleteArt={name:"Remove profile image",callback:function(d,e){a.updateUserProfile(b.currentUser(),{img:"generated"}).success(function(){c.changeableAttributes.profileImg="generated"})}}),"generated"!==c.changeableAttributes.profileImg&&(f.getDirectLink={name:"Get direct link to profile image",callback:function(){window.location.href=c.changeableAttributes.profileImg}}),_.isEmpty(f)||$.contextMenu({selector:".profile-img-menu",items:f,trigger:"hover",autoHide:!0})}})}}}]),app.directive("addToPlaylist",["$state","PlaylistsService","AuthService","$compile","$rootScope","$timeout",function(a,b,c,d,e,f){return{link:function(a,g){function h(){f(function(){i()})}function i(){var e={};if(c.isLoggedIn())b.getAllPlaylists({createdBy:c.currentUser()}).success(function(a){e["track-to-add"]={isHtmlName:!0,name:"Choose a playlist to add '<strong>"+$(g).attr("title")+"</strong>' from <strong>"+$(g).attr("tsource")+"</strong> to...",className:"track-to-add"},e["new-playlist"]={isHtmlName:!0,name:'<span class="middle-align"><i class="material-icons" style="display: inline;">add</i> <span>create a new playlist</span></span>',callback:function(){b.createNewAndRedirect()}},a.forEach(function(a){e[a._id]={name:a.name,callback:function(){b.addTrackToPlaylist(a,{title:$(g).attr("title"),source:$(g).attr("tsource"),playbackURL:$(g).attr("playback-url")}).success(function(){$.notify("Track added successfully.",{style:"below-nav"})}).error(function(a){$.notify(a.message,{style:"below-nav"})})}}});var c=Math.random().toString(36).slice(2);$(g).addClass("main-search-item-"+c);var d=".main-search-item-"+c;$.contextMenu({className:"css-title main-search-context-menu-"+c,selector:d,items:e,trigger:"left",autoHide:!0})});else{var h=Math.random().toString(36).slice(2),i=d("<a open-login href='#'>Log in</a>")(a);f(function(){a.$digest()},100),e["not-logged-in"]={isHtmlName:!0,name:"It seems likes you aren't logged in. <span replace-me-login-link></span>  or <a href='#' data-toggle='modal' data-target='#register-modal'>sign up</a> to add <strong>"+$(g).attr("title")+"</strong>' from <strong>"+$(g).attr("tsource")+"</strong> to a new playlist.",className:"context-not-logged-in-addplaylist"},$(g).addClass("main-search-item-"+h),$.contextMenu({className:"css-title main-search-context-menu-"+h,selector:".main-search-item-"+h,items:e,trigger:"left",autoHide:!0}),$("[replace-me-login-link]").replaceWith($(i))}}$("td.not-td-link").click(function(a){a.stopPropagation()}),e.$on("auth:logged-in",function(){h()}),e.$on("auth:logged-out",function(){h()}),h()}}}]),app.directive("openLogin",function(){return{link:function(a,b){$(b).click(function(a){a.stopPropagation(),$("#login-navbar-link").dropdown("toggle")})}}}),app.directive("closeRegister",function(){return{link:function(a,b){$(b).click(function(a){a.stopPropagation(),$("#register-modal").modal("toggle")})}}}),app.directive("login",function(){return{replace:!0,templateUrl:"/templates/partials/navbar/login.html"}}),app.directive("areYouSureDeleteTracks",function(){return{replace:!0,templateUrl:"/templates/partials/user_playlist/are_you_sure_tracks_delete.html"}}),app.directive("userDrop",function(){return{replace:!0,templateUrl:"/templates/partials/navbar/user_dropdown.html"}}),app.directive("stopProp",function(){return{link:function(a,b){$(b).on("click",function(a){$(a.target).is("a, a *")||a.stopPropagation()})}}}),app.directive("bootstrapTooltip",["$timeout",function(a){return{restrict:"A",link:function(b,c){a(function(){$(c).tooltip({trigger:"hover"})})}}}]),app.directive("tagsTypeahead",["$timeout","TagService",function(a,b){return{restrict:"A",link:function(c,d){b.getAllTags().success(function(b){a(function(){$(d).typeahead({hint:!0,highlight:!0,minLength:1},{name:"tags",source:new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,local:b}),templates:{header:"<div class='list-group'>",suggestion:function(a){return"<div class='list-group-item tags-list-item'>"+a+"</div>"}}}),$(d).bind("typeahead:select",function(a,b){c.tags.newTag=b})},0,!1)})}}}]),app.directive("quickAddTypeahead",["$timeout",function(a){return{restrict:"A",link:function(b,c){a(function(){$(c).typeahead({hint:!0,highlight:!0,minLength:1},{name:"quickAddYouTubeSearch",source:youtube,display:"title",templates:{suggestion:function(a){return"<div class='list-group-item tags-list-item'>"+a.title+"<div style='padding-top: 5px;'><small>"+a.source+"</small></div></div>"}}},{name:"quickAddSoundCloudSearch",source:soundcloud,display:"title",templates:{suggestion:function(a){return"<div class='list-group-item tags-list-item'>"+a.title+"<div style='padding-top: 5px;'><small>"+a.source+"</small></div></div>"}}}),$(c).bind("typeahead:select",function(a,c){
b.$apply(function(){b.addTrackToBeAdded(c)})})},0,!1)}}}]);